<%= form_with(model: [movie, review], url: review.persisted? ? movie_review_path(movie, review, year: year) : movie_reviews_path(movie, year: year), method: review.persisted? ? :patch : :post, class: "space-y-6") do |f| %>
  <%= render "shared/errors", object: review %>

  <% if f.object.errors[:stars].any? %>
    <div id="error_explanation" class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
      <ul class="list-disc space-y-1 pl-5">
        <% f.object.errors.full_messages_for(:stars).each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div data-controller="star-rating">
    <div class="flex items-center gap-4 min-w-[450px]">
      <div class="star-rating flex flex-row-reverse justify-start gap-2" data-action="mouseleave->star-rating#starMouseLeave">
        <% Review::STARS.reverse.each do |star| %>
          <%= f.radio_button :stars, star, id: "star_#{star}_#{review.object_id}", class: "hidden", checked: (review.persisted? && review.stars == star), data: { star_rating_target: "radio" } %>
          <%= label_tag "star_#{star}_#{review.object_id}", class: "cursor-pointer", data: { star_rating_target: "star", star_value: star, action: "mouseenter->star-rating#starMouseEnter click->star-rating#starClick" } do %>
            <svg class="star-icon star-unfilled" viewBox="0 0 68.53 66.85" xmlns="http://www.w3.org/2000/svg">
              <path d="M42.97,66.85c-2.98,0-5.86-.81-8.4-2.34-2.53,1.54-5.41,2.34-8.39,2.34-8.1,0-14.84-5.85-16.05-13.75-6.1-2.47-10.13-8.4-10.13-15.04,0-4.43,1.81-8.65,5-11.71-.2-1.02-.3-2.04-.3-3.03,0-8.95,7.28-16.24,16.24-16.24.08,0,.16,0,.24,0,3.04-4.45,7.98-7.08,13.39-7.08s10.36,2.63,13.39,7.08c.08,0,.16,0,.24,0,8.95,0,16.24,7.29,16.24,16.24,0,1.18-.14,2.37-.4,3.55,2.9,3.04,4.49,6.97,4.49,11.19,0,6.42-3.69,12.11-9.48,14.76-1.08,7.94-7.97,14.04-16.08,14.04ZM34.57,61.21c.3,0,.6.09.86.27,2.23,1.55,4.83,2.36,7.54,2.36,6.86,0,12.65-5.35,13.18-12.19.04-.57.41-1.07.95-1.28,5.12-2,8.43-6.84,8.43-12.32,0-3.67-1.48-7.1-4.18-9.63-.41-.38-.57-.96-.42-1.5.34-1.2.51-2.41.51-3.61,0-7.3-5.94-13.24-13.24-13.24-.26,0-.52.02-.77.04h-.15c-.55.07-1.1-.23-1.39-.71-2.43-4.01-6.66-6.41-11.32-6.41s-8.89,2.39-11.32,6.41c-.29.48-.83.78-1.39.72h-.15c-.26-.03-.51-.05-.77-.05-7.3,0-13.24,5.94-13.24,13.24,0,1.03.14,2.11.41,3.2.14.55-.05,1.13-.48,1.5-2.94,2.52-4.63,6.19-4.63,10.04,0,5.67,3.61,10.71,8.99,12.53.56.19.96.69,1.01,1.28.64,6.83,6.31,11.98,13.18,11.98,2.71,0,5.31-.82,7.54-2.36.26-.18.56-.27.86-.27Z"/>
              <path d="M34.26,14.48l3.94,10.64c.75,2.03,2.35,3.62,4.37,4.37l10.64,3.94-10.63,3.94c-2.03.75-3.62,2.35-4.37,4.37l-3.94,10.64-3.94-10.64c-.75-2.03-2.35-3.62-4.37-4.37l-10.64-3.94,10.64-3.94c2.03-.75,3.62-2.35,4.37-4.37l3.94-10.63Z"/>
            </svg>
          <% end %>
        <% end %>
      </div>
      <span data-star-rating-target="ratingDisplay" class="text-xl font-semibold text-slate-500 min-w-[3rem] hidden"></span>
    </div>
  </div>

  <div data-controller="date-picker">
    <%= f.label :watched_on, "Date Watched", class: "text-sm font-semibold text-slate-700" %>
    <div class="date-picker-wrapper mt-2">
      <%= f.text_field :watched_on,
          value: (review.watched_on || Date.current).strftime("%Y-%m-%d"),
          readonly: true,
          data: { date_picker_target: "input", action: "click->date-picker#toggleDropdown" },
          class: "date-picker-input" %>
      <i data-lucide="calendar" class="date-picker-icon"></i>
      <div class="date-picker-dropdown hidden" data-date-picker-target="dropdown">
        <div class="date-picker-header">
          <button type="button" class="date-picker-nav-btn" data-action="click->date-picker#previousMonth">
            <i data-lucide="chevron-left"></i>
          </button>
          <div class="date-picker-month-year" data-date-picker-target="monthYear"></div>
          <button type="button" class="date-picker-nav-btn" data-action="click->date-picker#nextMonth">
            <i data-lucide="chevron-right"></i>
          </button>
        </div>
        <div class="date-picker-grid" data-date-picker-target="grid"></div>
        <div class="date-picker-footer">
          <button type="button" class="date-picker-today-btn" data-action="click->date-picker#today">Today</button>
        </div>
      </div>
    </div>
  </div>

  <div>
    <%= f.label :comment, class: "text-sm font-semibold text-slate-700" %>
    <%= f.text_area :comment, class: "mt-2", placeholder: "What do you think, mate?", rows: 4 %>
  </div>

  <div class="flex items-center justify-end">
    <%= f.submit (review.persisted? && review.stars.present?) ? "Update" : "Mark as Watched",
        class: "inline-flex items-center rounded-md bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-slate-900",
        data: {
          star_rating_target: "submitButton",
          is_edit: ((review.persisted? && review.stars.present?) ? "true" : "false")
        } %>
  </div>
<% end %>
