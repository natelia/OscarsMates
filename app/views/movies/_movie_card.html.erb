<%# Movie Card Partial - Netflix-style with hover actions %>
<%# Local variables: movie, review (optional), show_actions (default true), sort_by (optional), pick_count (optional) %>
<% review ||= nil %>
<% show_actions = local_assigns.fetch(:show_actions, true) %>
<% sort_by ||= nil %>
<% pick_count = local_assigns[:pick_count] %>

<div class="movie-card <%= 'is-watched' if review %>"
     data-controller="movie-card"
     data-movie-id="<%= movie.id %>"
     data-reviewed="<%= !!review %>"
     id="movie-card-<%= movie.id %>">

  <%# User's rating badge - clickable to edit review %>
  <% if review&.stars.present? %>
    <%= link_to edit_movie_review_path(movie, review, year: current_year),
        class: "movie-card-badge animate-float",
        data: { turbo: false } do %>
      <span class="rating-number"><%= review.stars %></span>
      <i data-lucide="edit-2" class="edit-icon"></i>
    <% end %>
  <% end %>

  <%# Movie poster container with overlay %>
  <div class="movie-card-poster-container">
    <% if movie.picture_url.present? %>
      <img src="<%= movie.picture_url %>"
           alt="<%= movie.title %>"
           class="movie-card-poster"
           loading="lazy">
    <% else %>
      <div class="movie-card-poster flex items-center justify-center bg-gold-light">
        <i data-lucide="film" class="text-muted text-4xl"></i>
      </div>
    <% end %>

    <%# Hover overlay with actions %>
    <% if show_actions && current_user %>
      <div class="movie-card-overlay">
          <div class="movie-card-actions">
            <% unless review %>
              <%= link_to new_movie_review_path(movie, year: current_year), class: "btn-outline-oscar btn-sm" do %>
                <i data-lucide="popcorn" style="font-size: 1.75rem;"></i> Watched
              <% end %>
            <% end %>
          </div>
      </div>
    <% end %>
  </div>

  <%# Title and ratings (always visible) %>
  <div class="movie-card-info">
    <h4><%= movie.title %></h4>
  <div class="movie-rating-row">
    <% if pick_count %>
      <%# Show mates' votes count on Categories page %>
      <div class="movie-rating-left">
        <i data-lucide="users" class="text-muted"></i>
        <span><%= pick_count %> <%= pick_count == 1 ? "mate's" : "mates'" %> votes</span>
      </div>
    <% elsif sort_by == 'duration' || sort_by == 'shortest' %>
      <%# Show duration when sorting by duration %>
      <div class="movie-rating-left">
        <i data-lucide="timer" class="text-muted"></i>
        <span><%= movie.runtime %> mins</span>
      </div>
    <% elsif sort_by == 'most_watched_by_mates' %>
      <%# Show mate watch count when sorting by popularity %>
      <div class="movie-rating-left">
        <% watch_count = movie.try(:mates_watch_count) || 0 %>
        <i data-lucide="users" class="text-muted"></i>
        <span><%= watch_count %> <%= 'mate'.pluralize(watch_count) %></span>
      </div>
    <% else %>
      <%# Show ratings normally %>
      <div class="movie-rating-left">
        <% if movie.average_stars.zero? %>
          <i data-lucide="users" class="text-muted"></i>
          <span class="text-muted">No ratings</span>
        <% else %>
          <i data-lucide="users" class="text-muted"></i>
          <span><%= number_with_precision(movie.average_stars, precision: 1) %></span>
        <% end %>
      </div>
      <div class="movie-rating-right">
        <% if movie.rating.zero? %>
          <i data-lucide="film" class="text-muted"></i>
          <span class="text-muted">-</span>
        <% else %>
          <%= link_to movie.url, target: "_blank", class: "flex items-center gap-1 text-slate-600 hover:text-[var(--oscar-gold-dark)] transition-colors duration-150" do %>
            <i data-lucide="film"></i>
            <span><%= number_with_precision(movie.rating, precision: 1) %></span>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>
  </div>
</div>
