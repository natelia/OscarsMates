<a id="top"></a>

<main class="movies-page">
  <div class="container mx-auto px-4 py-8">

    <%# User Stats %>
    <% if current_user && @user_stats %>
      <div class="user-stats-section">
        <h3 class="user-stats-title">Watched</h3>

        <%# Films %>
        <div class="user-stats-row">
          <span class="user-stats-name"><i data-lucide="film"></i> Movies</span>
          <div class="user-stats-bar">
            <div class="user-stats-fill" style="width: <%= @user_stats[:films][:percentage] %>%;"></div>
          </div>
          <span class="user-stats-label"><%= @user_stats[:films][:watched] %>/<%= @totals[:films] %></span>
          <span class="user-stats-percentage"><%= @user_stats[:films][:percentage].round %>%</span>
          <span class="user-stats-remaining"><%= @totals[:films] - @user_stats[:films][:watched] %> left</span>
        </div>

        <%# Minutes %>
        <div class="user-stats-row">
          <span class="user-stats-name"><i data-lucide="clock"></i> Time</span>
          <div class="user-stats-bar">
            <div class="user-stats-fill" style="width: <%= @user_stats[:minutes][:percentage] %>%;"></div>
          </div>
          <span class="user-stats-label"><%= (@user_stats[:minutes][:watched] / 60.0).round %>h/<%= (@totals[:minutes] / 60.0).round %>h</span>
          <span class="user-stats-percentage"><%= @user_stats[:minutes][:percentage].round %>%</span>
          <span class="user-stats-remaining"><%= ((@totals[:minutes] - @user_stats[:minutes][:watched]) / 60.0).round %>h left</span>
        </div>

        <%# Nominations %>
        <div class="user-stats-row">
          <span class="user-stats-name"><i data-lucide="trophy"></i> Nominations</span>
          <div class="user-stats-bar">
            <div class="user-stats-fill" style="width: <%= @user_stats[:nominations][:percentage] %>%;"></div>
          </div>
          <span class="user-stats-label"><%= @user_stats[:nominations][:watched] %>/<%= @totals[:nominations] %></span>
          <span class="user-stats-percentage"><%= @user_stats[:nominations][:percentage].round %>%</span>
          <span class="user-stats-remaining"><%= @totals[:nominations] - @user_stats[:nominations][:watched] %> left</span>
        </div>
      </div>
    <% end %>

    <%# Toolbar %>
    <div class="toolbar">
      <%# Filter Pill Group - Far Left %>
      <% if current_user.present? %>
        <div class="toolbar-left">
          <div class="filter-pill">
            <%= link_to movies_path(year: current_year, sort_by: params[:sort_by], query: params[:query]),
                class: "filter-option #{'active' if params[:filter_by].blank?}" do %>
              <i data-lucide="gallery-horizontal-end"></i> All
            <% end %>
            <%= link_to movies_path(year: current_year, filter_by: 'unwatched', sort_by: params[:sort_by], query: params[:query]),
                class: "filter-option #{'active' if params[:filter_by] == 'unwatched'}" do %>
              <i data-lucide="eye-off"></i> Unwatched
            <% end %>
            <%= link_to movies_path(year: current_year, filter_by: 'watched', sort_by: params[:sort_by], query: params[:query]),
                class: "filter-option #{'active' if params[:filter_by] == 'watched'}" do %>
              <i data-lucide="eye"></i> Watched
            <% end %>
          </div>
        </div>
      <% end %>

      <%# Search - Middle %>
      <div class="search-wrapper">
        <form class="search-form" role="search" action="<%= movies_path(year: current_year) %>" method="get">
          <i data-lucide="search" class="search-icon"></i>
          <input class="search-input"
                 type="search"
                 name="query"
                 placeholder="Search movies..."
                 aria-label="Search"
                 value="<%= params[:query] %>">
          <% if params[:query].present? %>
            <%= link_to movies_path(year: current_year, filter_by: params[:filter_by], sort_by: params[:sort_by]), class: "search-clear" do %>
              <i data-lucide="x" class="text-muted"></i>
            <% end %>
          <% end %>
        </form>
      </div>

      <%# Admin Add Button & Sort Dropdown - Far Right %>
      <% if current_user.present? %>
        <div class="toolbar-right">
          <% if current_user_admin? %>
            <%= link_to new_movie_path(year: current_year), class: "btn-admin-add" do %>
              <i data-lucide="plus"></i>
            <% end %>
          <% end %>
          <div class="hs-dropdown relative">
            <button class="toolbar-dropdown-btn hs-dropdown-toggle" type="button" aria-expanded="false">
              <i data-lucide="arrow-down-wide-narrow" class="text-muted"></i>
              <span><%= sort_label(params[:sort_by]) %></span>
              <i data-lucide="chevron-down" class="text-muted"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-sort hs-dropdown-menu transition-[opacity,margin] duration-200 opacity-0 hs-dropdown-open:opacity-100 hidden mt-2">
              <li>
                <%= link_to movies_path(year: current_year, sort_by: '', filter_by: params[:filter_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by].blank?}" do %>
                  <i data-lucide="sort-desc" class="text-muted"></i> A-Z
                <% end %>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li class="dropdown-header">By Rating</li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'watched_by_mates', filter_by: params[:filter_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'watched_by_mates'}" do %>
                  <i data-lucide="users" class="text-muted"></i> Mates' Rating
                <% end %>
              </li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'imdb_rating', filter_by: params[:filter_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'imdb_rating'}" do %>
                  <i data-lucide="film" class="text-muted"></i> IMDB Rating
                <% end %>
              </li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'my_rating', filter_by: params[:filter_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'my_rating'}" do %>
                  <i data-lucide="star" class="text-muted"></i> My Rating
                <% end %>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li class="dropdown-header">By Duration</li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'duration', filter_by: params[:filter_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'duration'}" do %>
                  <i data-lucide="timer" class="text-muted"></i> Longest First
                <% end %>
              </li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'shortest', filter_by: params[:filter_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'shortest'}" do %>
                  <i data-lucide="clock" class="text-muted"></i> Shortest First
                <% end %>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li class="dropdown-header">By Popularity</li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'most_watched_by_mates', filter_by: params[:filter_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'most_watched_by_mates'}" do %>
                  <i data-lucide="eye" class="text-muted"></i> Most Watched by Mates
                <% end %>
              </li>
            </ul>
          </div>
        </div>
      <% end %>
    </div>

    <%# Celebration %>
    <div data-controller="confetti" data-confetti-enabled-value="<%= @all_movies_watched %>">
      <% if @all_movies_watched %>
        <div class="rounded-oscar mb-4 flex items-center justify-center gap-2 border border-amber-200 bg-gold-light px-4 py-3 text-center animate-fade-in-up">
          <i data-lucide="trophy" class="text-gold" style="font-size: 1.5rem;"></i>
          <strong>Congratulations!</strong> You've watched all <%= current_year %> Oscar nominees!
        </div>
      <% end %>
    </div>

    <%# Movie Grid %>
    <% if @movies.any? %>
      <div class="movies-grid">
        <% @movies.each_with_index do |movie, index| %>
          <div class="animate-fade-in-up animate-delay-<%= [index + 1, 12].min %>">
            <%= render 'movie_card', movie: movie, review: @user_reviews[movie.id], sort_by: params[:sort_by] %>
          </div>
        <% end %>
      </div>
    <% else %>
    <%# Empty State %>
     <div class="empty-state">
      <div class="empty-icon">
        <% if params[:filter_by] == 'watched' %>
          <%= image_tag 'empty_watched.svg', class: 'empty-state-svg' %>
        <% elsif params[:filter_by] == 'unwatched' %>
          <%= image_tag 'empty_unwatched.svg', class: 'empty-state-svg' %>
        <% else %>
          <%= image_tag 'empty_watched.svg', class: 'empty-state-svg' %>
        <% end %>
      </div>
      <h3>No movies found</h3>
      <p>
        <% if params[:query].present? %>
          No results for "<%= params[:query] %>". Try a different search.
        <% elsif params[:filter_by] == 'unwatched' %>
          You've watched everything! Amazing!
        <% elsif params[:filter_by] == 'watched' %>
          You haven't watched any movies yet. Start watching!
        <% end %>
      </p>
        <% if params[:query].present? || params[:filter_by].present? %>
          <%= link_to movies_path(year: current_year), class: "btn-clear-filters" do %>
            <i data-lucide="x" class="text-muted"></i> Clear Filters
          <% end %>
        <% end %>
        </div>
    <% end %>

  </div>

  <%# Back to Top %>
  <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="back-to-top" title="Back to top">
    <i data-lucide="arrow-up" style="color: var(--text-tertiary);"></i>
  </button>
</main>

<style>
.back-to-top {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--card-shadow-lg);
  z-index: 100;
  opacity: 0.9;
  transition: var(--transition-smooth);
  background: var(--bg-secondary);
}

.back-to-top:hover {
  opacity: 1;
  transform: translateY(-4px);
}

/* Toolbar responsive */
@media (max-width: 768px) {
  .toolbar {
    flex-direction: column;
    gap: 1rem;
  }

  .toolbar form {
    width: 100% !important;
    max-width: none !important;
  }
}
</style>
