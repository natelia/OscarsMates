<a id="top"></a>

<main class="movies-page">
  <div class="container py-5">

    <%# Toolbar %>
    <div class="toolbar">
      <%# Search %>
      <div class="search-wrapper">
        <form class="search-form" role="search" action="<%= movies_path(year: current_year) %>" method="get">
          <i class="bi bi-search search-icon"></i>
          <input class="search-input"
                 type="search"
                 name="query"
                 placeholder="Search movies..."
                 aria-label="Search"
                 value="<%= params[:query] %>">
          <% if params[:query].present? %>
            <%= link_to movies_path(year: current_year, filter_by: params[:filter_by], sort_by: params[:sort_by]), class: "search-clear" do %>
              <i class="bi bi-x"></i>
            <% end %>
          <% end %>
        </form>
      </div>

      <% if current_user.present? %>
        <div class="toolbar-actions">
          <%# Filter Dropdown %>
          <div class="dropdown">
            <button class="toolbar-dropdown-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-funnel"></i>
              <span><%= filter_label(params[:filter_by]) %></span>
              <i class="bi bi-chevron-down"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-filter">
              <li>
                <%= link_to movies_path(year: current_year, sort_by: params[:sort_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:filter_by].blank?}" do %>
                  <i class="bi bi-grid"></i> All Movies
                <% end %>
              </li>
              <li>
                <%= link_to movies_path(year: current_year, filter_by: 'unwatched', sort_by: params[:sort_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:filter_by] == 'unwatched'}" do %>
                  <i class="bi bi-eye-slash"></i> Unwatched
                <% end %>
              </li>
              <li>
                <%= link_to movies_path(year: current_year, filter_by: 'watched', sort_by: params[:sort_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:filter_by] == 'watched'}" do %>
                  <i class="bi bi-eye"></i> Watched
                <% end %>
              </li>
            </ul>
          </div>

          <%# Sort Dropdown %>
          <div class="dropdown">
            <button class="toolbar-dropdown-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-sort-down"></i>
              <span><%= sort_label(params[:sort_by]) %></span>
              <i class="bi bi-chevron-down"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-sort">
              <li>
                <%= link_to movies_path(year: current_year, sort_by: '', filter_by: params[:filter_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by].blank?}" do %>
                  <i class="bi bi-sort-alpha-down"></i> A-Z
                <% end %>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li class="dropdown-header">By Rating</li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'my_rating', filter_by: params[:filter_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'my_rating'}" do %>
                  <i class="bi bi-star"></i> My Rating
                <% end %>
              </li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'imdb_rating', filter_by: params[:filter_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'imdb_rating'}" do %>
                  <i class="bi bi-film"></i> IMDB Rating
                <% end %>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li class="dropdown-header">By Duration</li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'duration', filter_by: params[:filter_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'duration'}" do %>
                  <i class="bi bi-hourglass-top"></i> Longest First
                <% end %>
              </li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'shortest', filter_by: params[:filter_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'shortest'}" do %>
                  <i class="bi bi-hourglass-bottom"></i> Shortest First
                <% end %>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li class="dropdown-header">By Popularity</li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'watched_by_mates', filter_by: params[:filter_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'watched_by_mates'}" do %>
                  <i class="bi bi-people"></i> Mates' Rating
                <% end %>
              </li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'most_nominated', filter_by: params[:filter_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'most_nominated'}" do %>
                  <i class="bi bi-trophy"></i> Most Nominated
                <% end %>
              </li>
            </ul>
          </div>
        </div>
      <% end %>
    </div>

    <%# Celebration %>
    <div data-controller="confetti" data-confetti-enabled-value="<%= @all_movies_watched %>">
      <% if @all_movies_watched %>
        <div class="alert bg-gold-light text-center rounded-oscar mb-4 animate-fade-in-up">
          <i class="bi bi-trophy-fill text-gold me-2" style="font-size: 1.5rem;"></i>
          <strong>Congratulations!</strong> You've watched all <%= current_year %> Oscar nominees!
        </div>
      <% end %>
    </div>

    <%# Movie Grid %>
    <% if @movies.any? %>
      <div class="movies-grid">
        <% @movies.each_with_index do |movie, index| %>
          <div class="animate-fade-in-up animate-delay-<%= [index + 1, 12].min %>">
            <%= render 'movie_card', movie: movie, review: @user_reviews[movie.id] %>
          </div>
        <% end %>
      </div>

      <%= render 'shared/pagination' %>
    <% else %>
      <%# Empty State %>
      <div class="empty-state">
        <div class="empty-icon">
          <i class="bi bi-film"></i>
        </div>
        <h3>No movies found</h3>
        <p>
          <% if params[:query].present? %>
            No results for "<%= params[:query] %>". Try a different search.
          <% elsif params[:filter_by] == 'unwatched' %>
            You've watched everything! Amazing!
          <% else %>
            No movies available for this year yet.
          <% end %>
        </p>
        <% if params[:query].present? || params[:filter_by].present? %>
          <%= link_to "Clear Filters", movies_path(year: current_year), class: "btn btn-oscar" %>
        <% end %>
      </div>
    <% end %>

    <%# Admin Button %>
    <% if current_user_admin? %>
      <div class="text-center mt-4">
        <%= link_to new_movie_path(year: current_year), class: "btn btn-outline-oscar" do %>
          <i class="bi bi-plus-circle me-1"></i> Add New Movie
        <% end %>
      </div>
    <% end %>
  </div>

  <%# Back to Top %>
  <a href="#top" class="btn btn-oscar back-to-top" title="Back to top">
    <i class="bi bi-chevron-up"></i>
  </a>
</main>

<style>
.back-to-top {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--card-shadow-lg);
  z-index: 100;
  opacity: 0.9;
  transition: var(--transition-smooth);
}

.back-to-top:hover {
  opacity: 1;
  transform: translateY(-4px);
}

/* Toolbar responsive */
@media (max-width: 768px) {
  .toolbar {
    flex-direction: column;
    gap: 1rem;
  }

  .toolbar form {
    width: 100% !important;
    max-width: none !important;
  }
}
</style>
