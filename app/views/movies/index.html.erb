<a id="top"></a>

<main class="movies-page">
  <div class="container mx-auto px-4 py-8">

    <%# User Stats %>
    <% if current_user && @user_stats %>
      <div class="user-stats-section">
        <h3 class="user-stats-title">Watched</h3>

        <%# Films %>
        <div class="user-stats-row">
          <span class="user-stats-name"><i data-lucide="film"></i> Movies</span>
          <div class="user-stats-bar">
            <div class="user-stats-fill" style="width: <%= @user_stats[:films][:percentage] %>%;"></div>
          </div>
          <span class="user-stats-label"><%= @user_stats[:films][:watched] %>/<%= @totals[:films] %></span>
          <span class="user-stats-percentage"><%= @user_stats[:films][:percentage].round %>%</span>
          <span class="user-stats-remaining"><%= @totals[:films] - @user_stats[:films][:watched] %> left</span>
        </div>

        <%# Minutes %>
        <div class="user-stats-row">
          <span class="user-stats-name"><i data-lucide="clock"></i> Time</span>
          <div class="user-stats-bar">
            <div class="user-stats-fill" style="width: <%= @user_stats[:minutes][:percentage] %>%;"></div>
          </div>
          <span class="user-stats-label"><%= (@user_stats[:minutes][:watched] / 60.0).round %>h/<%= (@totals[:minutes] / 60.0).round %>h</span>
          <span class="user-stats-percentage"><%= @user_stats[:minutes][:percentage].round %>%</span>
          <span class="user-stats-remaining"><%= ((@totals[:minutes] - @user_stats[:minutes][:watched]) / 60.0).round %>h left</span>
        </div>

        <%# Nominations %>
        <div class="user-stats-row">
          <span class="user-stats-name"><i data-lucide="trophy"></i> Nominations</span>
          <div class="user-stats-bar">
            <div class="user-stats-fill" style="width: <%= @user_stats[:nominations][:percentage] %>%;"></div>
          </div>
          <span class="user-stats-label"><%= @user_stats[:nominations][:watched] %>/<%= @totals[:nominations] %></span>
          <span class="user-stats-percentage"><%= @user_stats[:nominations][:percentage].round %>%</span>
          <span class="user-stats-remaining"><%= @totals[:nominations] - @user_stats[:nominations][:watched] %> left</span>
        </div>
      </div>
    <% end %>

    <%# Toolbar %>
    <div class="toolbar">
      <%# Filter Pill Group - Far Left %>
      <% if current_user.present? %>
        <div class="toolbar-left">
          <div class="filter-pill">
            <%= link_to movies_path(year: current_year, sort_by: params[:sort_by], category_id: params[:category_id], query: params[:query]),
                class: "filter-option #{'active' if params[:filter_by].blank?}" do %>
              <i data-lucide="gallery-horizontal-end"></i> All
            <% end %>
            <%= link_to movies_path(year: current_year, filter_by: 'unwatched', sort_by: params[:sort_by], category_id: params[:category_id], query: params[:query]),
                class: "filter-option #{'active' if params[:filter_by] == 'unwatched'}" do %>
              <i data-lucide="eye-off"></i> Unwatched
            <% end %>
            <%= link_to movies_path(year: current_year, filter_by: 'watched', sort_by: params[:sort_by], category_id: params[:category_id], query: params[:query]),
                class: "filter-option #{'active' if params[:filter_by] == 'watched'}" do %>
              <i data-lucide="eye"></i> Watched
            <% end %>
          </div>
        </div>
      <% end %>

      <%# Search - Middle %>
      <div class="search-wrapper">
        <form class="search-form" role="search" action="<%= movies_path(year: current_year) %>" method="get">
          <i data-lucide="search" class="search-icon"></i>
          <input class="search-input"
                 type="search"
                 name="query"
                 placeholder="Search movies..."
                 aria-label="Search"
                 value="<%= params[:query] %>">
          <input type="hidden" name="filter_by" value="<%= params[:filter_by] %>">
          <input type="hidden" name="sort_by" value="<%= params[:sort_by] %>">
          <input type="hidden" name="category_id" value="<%= params[:category_id] %>">
          <% if params[:query].present? %>
            <%= link_to movies_path(year: current_year, filter_by: params[:filter_by], sort_by: params[:sort_by], category_id: params[:category_id]), class: "search-clear" do %>
              <i data-lucide="x" class="text-muted"></i>
            <% end %>
          <% end %>
        </form>
      </div>

      <%# Admin Add Button & Sort Dropdown - Far Right %>
      <% if current_user.present? %>
        <div class="toolbar-right">
          <% if current_user_admin? %>
            <%= link_to new_movie_path(year: current_year), class: "btn-admin-add" do %>
              <i data-lucide="plus"></i>
            <% end %>
          <% end %>

          <%# Desktop Category Dropdown %>
          <div class="hs-dropdown relative hidden sm:block">
            <button class="toolbar-dropdown-btn hs-dropdown-toggle" type="button" aria-expanded="false">
              <i data-lucide="trophy" class="text-muted"></i>
              <span><%= @selected_category&.name || 'All Categories' %></span>
              <i data-lucide="chevron-down" class="text-muted"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-sort hs-dropdown-menu transition-[opacity,margin] duration-200 opacity-0 hs-dropdown-open:opacity-100 hidden mt-2" style="max-height: 400px; overflow-y: auto;">
              <li>
                <%= link_to movies_path(year: current_year, sort_by: params[:sort_by], filter_by: params[:filter_by], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:category_id].blank?}" do %>
                  <i data-lucide="gallery-horizontal-end" class="text-muted"></i> All Categories
                <% end %>
              </li>
              <li><hr class="dropdown-divider"></li>
              <% @categories.each do |category| %>
                <li>
                  <%= link_to movies_path(year: current_year, category_id: category.id, sort_by: params[:sort_by], filter_by: params[:filter_by], query: params[:query]),
                      class: "dropdown-item #{'active' if params[:category_id].to_s == category.id.to_s}" do %>
                    <%= category.name %>
                  <% end %>
                </li>
              <% end %>
            </ul>
          </div>

          <%# Desktop Sort Dropdown %>
          <div class="hs-dropdown relative hidden sm:block">
            <button class="toolbar-dropdown-btn hs-dropdown-toggle" type="button" aria-expanded="false">
              <i data-lucide="arrow-down-wide-narrow" class="text-muted"></i>
              <span><%= sort_label(params[:sort_by]) %></span>
              <i data-lucide="chevron-down" class="text-muted"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-sort hs-dropdown-menu transition-[opacity,margin] duration-200 opacity-0 hs-dropdown-open:opacity-100 hidden mt-2">
              <li>
                <%= link_to movies_path(year: current_year, sort_by: '', filter_by: params[:filter_by], category_id: params[:category_id], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by].blank?}" do %>
                  <i data-lucide="sort-desc" class="text-muted"></i> A-Z
                <% end %>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li class="dropdown-header">By rating</li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'watched_by_mates', filter_by: params[:filter_by], category_id: params[:category_id], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'watched_by_mates'}" do %>
                  <i data-lucide="users" class="text-muted"></i> Mates' rating
                <% end %>
              </li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'imdb_rating', filter_by: params[:filter_by], category_id: params[:category_id], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'imdb_rating'}" do %>
                  <i data-lucide="film" class="text-muted"></i> IMDB rating
                <% end %>
              </li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'my_rating', filter_by: params[:filter_by], category_id: params[:category_id], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'my_rating'}" do %>
                  <i data-lucide="star" class="text-muted"></i> My rating
                <% end %>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li class="dropdown-header">By duration</li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'duration', filter_by: params[:filter_by], category_id: params[:category_id], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'duration'}" do %>
                  <i data-lucide="timer" class="text-muted"></i> Longest first
                <% end %>
              </li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'shortest', filter_by: params[:filter_by], category_id: params[:category_id], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'shortest'}" do %>
                  <i data-lucide="clock" class="text-muted"></i> Shortest first
                <% end %>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li class="dropdown-header">By popularity</li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'most_nominated', filter_by: params[:filter_by], category_id: params[:category_id], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'most_nominated'}" do %>
                  <i data-lucide="trophy" class="text-muted"></i> Most nominated
                <% end %>
              </li>
              <li>
                <%= link_to movies_path(year: current_year, sort_by: 'most_watched_by_mates', filter_by: params[:filter_by], category_id: params[:category_id], query: params[:query]),
                    class: "dropdown-item #{'active' if params[:sort_by] == 'most_watched_by_mates'}" do %>
                  <i data-lucide="eye" class="text-muted"></i> Most watched by mates
                <% end %>
              </li>
            </ul>
          </div>

          <%# Mobile Modal Buttons %>
          <button type="button" class="toolbar-dropdown-btn sm:hidden" data-hs-overlay="#category-modal" aria-label="Category filter">
            <i data-lucide="trophy" class="text-muted"></i>
          </button>
          <button type="button" class="toolbar-dropdown-btn sm:hidden" data-hs-overlay="#sort-modal" aria-label="Sort options">
            <i data-lucide="arrow-down-wide-narrow" class="text-muted"></i>
          </button>
        </div>
      <% end %>
    </div>

    <%# Celebration %>
    <div data-controller="confetti" data-confetti-enabled-value="<%= @all_movies_watched %>">
      <% if @all_movies_watched %>
        <div class="rounded-oscar mb-4 flex items-center justify-center gap-2 border border-amber-200 bg-gold-light px-4 py-3 text-center animate-fade-in-up">
          <i data-lucide="trophy" class="text-gold" style="font-size: 1.5rem;"></i>
          <strong>Congratulations!</strong> You've watched all <%= current_year %> Oscar nominees!
        </div>
      <% end %>
    </div>

    <%# Movie Grid %>
    <% if @movies.any? %>
      <div class="movies-grid">
        <% @movies.each_with_index do |movie, index| %>
          <div class="animate-fade-in-up animate-delay-<%= [index + 1, 12].min %>">
            <%= render 'movie_card', movie: movie, review: @user_reviews[movie.id], sort_by: params[:sort_by] %>
          </div>
        <% end %>
      </div>
    <% else %>
    <%# Empty State %>
     <div class="empty-state">
      <div class="empty-icon">
        <% if params[:filter_by] == 'watched' %>
          <%= image_tag 'empty_watched.svg', class: 'empty-state-svg' %>
        <% elsif params[:filter_by] == 'unwatched' %>
          <%= image_tag 'empty_unwatched.svg', class: 'empty-state-svg' %>
        <% else %>
          <%= image_tag 'empty_watched.svg', class: 'empty-state-svg' %>
        <% end %>
      </div>
      <h3>No movies found</h3>
      <p>
        <% if params[:query].present? %>
          No results for "<%= params[:query] %>". Try a different search.
        <% elsif params[:filter_by] == 'unwatched' %>
          You've watched everything! Amazing!
        <% elsif params[:filter_by] == 'watched' %>
          You haven't watched any movies yet. Start watching!
        <% end %>
      </p>
        <% if params[:query].present? || params[:filter_by].present? || params[:category_id].present? %>
          <%= link_to movies_path(year: current_year), class: "btn-clear-filters" do %>
            <i data-lucide="x" class="text-muted"></i> Clear Filters
          <% end %>
        <% end %>
        </div>
    <% end %>

  </div>

  <%# Back to Top %>
  <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="back-to-top" title="Back to top">
    <i data-lucide="arrow-up" style="color: var(--text-tertiary);"></i>
  </button>
</main>

<%# Mobile Sort Modal - Always Light Mode %>
<% if current_user.present? %>
  <div id="sort-modal" class="hs-overlay hidden w-full h-full fixed top-0 start-0 z-[80] overflow-x-hidden overflow-y-auto pointer-events-none">
    <div class="hs-overlay-open:mt-7 hs-overlay-open:opacity-100 hs-overlay-open:duration-500 mt-0 opacity-0 ease-out transition-all sm:max-w-lg sm:w-full m-3 sm:mx-auto min-h-[calc(100%-3.5rem)] flex items-center">
      <div class="w-full max-w-md mx-auto flex flex-col bg-white border border-gray-200 shadow-lg rounded-xl pointer-events-auto">
        <%# Header %>
        <div class="flex justify-between items-center py-3 px-4 border-b border-gray-200">
          <h3 class="font-bold text-gray-800">
            Sort Movies
          </h3>
          <button type="button" class="flex justify-center items-center w-7 h-7 text-sm font-semibold rounded-full border border-transparent text-gray-800 hover:bg-gray-100 disabled:opacity-50 disabled:pointer-events-none" data-hs-overlay="#sort-modal">
            <span class="sr-only">Close</span>
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>

        <%# Body with Sort Options %>
        <div class="p-4 overflow-y-auto">
          <div class="space-y-2">
            <%= link_to movies_path(year: current_year, sort_by: '', filter_by: params[:filter_by], category_id: params[:category_id], query: params[:query]),
                class: "flex items-center gap-3 px-4 py-3 text-sm text-gray-800 rounded-lg hover:bg-gray-100 #{'bg-gray-100 font-semibold' if params[:sort_by].blank?}" do %>
              <i data-lucide="sort-desc" class="text-muted w-5 h-5"></i>
              <span>A-Z</span>
            <% end %>

            <div class="border-t border-gray-200 pt-2">
              <p class="px-4 py-2 text-xs font-semibold text-gray-500">By rating</p>
              <%= link_to movies_path(year: current_year, sort_by: 'watched_by_mates', filter_by: params[:filter_by], category_id: params[:category_id], query: params[:query]),
                  class: "flex items-center gap-3 px-4 py-3 text-sm text-gray-800 rounded-lg hover:bg-gray-100 #{'bg-gray-100 font-semibold' if params[:sort_by] == 'watched_by_mates'}" do %>
                <i data-lucide="users" class="text-muted w-5 h-5"></i>
                <span>Mates' rating</span>
              <% end %>
              <%= link_to movies_path(year: current_year, sort_by: 'imdb_rating', filter_by: params[:filter_by], category_id: params[:category_id], query: params[:query]),
                  class: "flex items-center gap-3 px-4 py-3 text-sm text-gray-800 rounded-lg hover:bg-gray-100 #{'bg-gray-100 font-semibold' if params[:sort_by] == 'imdb_rating'}" do %>
                <i data-lucide="film" class="text-muted w-5 h-5"></i>
                <span>IMDB rating</span>
              <% end %>
              <%= link_to movies_path(year: current_year, sort_by: 'my_rating', filter_by: params[:filter_by], category_id: params[:category_id], query: params[:query]),
                  class: "flex items-center gap-3 px-4 py-3 text-sm text-gray-800 rounded-lg hover:bg-gray-100 #{'bg-gray-100 font-semibold' if params[:sort_by] == 'my_rating'}" do %>
                <i data-lucide="star" class="text-muted w-5 h-5"></i>
                <span>My rating</span>
              <% end %>
            </div>

            <div class="border-t border-gray-200 pt-2">
              <p class="px-4 py-2 text-xs font-semibold text-gray-500">By duration</p>
              <%= link_to movies_path(year: current_year, sort_by: 'duration', filter_by: params[:filter_by], category_id: params[:category_id], query: params[:query]),
                  class: "flex items-center gap-3 px-4 py-3 text-sm text-gray-800 rounded-lg hover:bg-gray-100 #{'bg-gray-100 font-semibold' if params[:sort_by] == 'duration'}" do %>
                <i data-lucide="timer" class="text-muted w-5 h-5"></i>
                <span>Longest first</span>
              <% end %>
              <%= link_to movies_path(year: current_year, sort_by: 'shortest', filter_by: params[:filter_by], category_id: params[:category_id], query: params[:query]),
                  class: "flex items-center gap-3 px-4 py-3 text-sm text-gray-800 rounded-lg hover:bg-gray-100 #{'bg-gray-100 font-semibold' if params[:sort_by] == 'shortest'}" do %>
                <i data-lucide="clock" class="text-muted w-5 h-5"></i>
                <span>Shortest first</span>
              <% end %>
            </div>

            <div class="border-t border-gray-200 pt-2">
              <p class="px-4 py-2 text-xs font-semibold text-gray-500">By popularity</p>
              <%= link_to movies_path(year: current_year, sort_by: 'most_nominated', filter_by: params[:filter_by], category_id: params[:category_id], query: params[:query]),
                  class: "flex items-center gap-3 px-4 py-3 text-sm text-gray-800 rounded-lg hover:bg-gray-100 #{'bg-gray-100 font-semibold' if params[:sort_by] == 'most_nominated'}" do %>
                <i data-lucide="trophy" class="text-muted w-5 h-5"></i>
                <span>Most nominated</span>
              <% end %>
              <%= link_to movies_path(year: current_year, sort_by: 'most_watched_by_mates', filter_by: params[:filter_by], category_id: params[:category_id], query: params[:query]),
                  class: "flex items-center gap-3 px-4 py-3 text-sm text-gray-800 rounded-lg hover:bg-gray-100 #{'bg-gray-100 font-semibold' if params[:sort_by] == 'most_watched_by_mates'}" do %>
                <i data-lucide="eye" class="text-muted w-5 h-5"></i>
                <span>Most watched by mates</span>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%# Mobile Category Modal %>
  <div id="category-modal" class="hs-overlay hidden w-full h-full fixed top-0 start-0 z-[80] overflow-x-hidden overflow-y-auto pointer-events-none">
    <div class="hs-overlay-open:mt-7 hs-overlay-open:opacity-100 hs-overlay-open:duration-500 mt-0 opacity-0 ease-out transition-all sm:max-w-lg sm:w-full m-3 sm:mx-auto min-h-[calc(100%-3.5rem)] flex items-center">
      <div class="w-full max-w-md mx-auto flex flex-col bg-white border border-gray-200 shadow-lg rounded-xl pointer-events-auto">
        <%# Header %>
        <div class="flex justify-between items-center py-3 px-4 border-b border-gray-200">
          <h3 class="font-bold text-gray-800">
            Filter by Category
          </h3>
          <button type="button" class="flex justify-center items-center w-7 h-7 text-sm font-semibold rounded-full border border-transparent text-gray-800 hover:bg-gray-100 disabled:opacity-50 disabled:pointer-events-none" data-hs-overlay="#category-modal">
            <span class="sr-only">Close</span>
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>

        <%# Body with Category Options %>
        <div class="p-4 overflow-y-auto" style="max-height: 60vh;">
          <div class="space-y-2">
            <%= link_to movies_path(year: current_year, sort_by: params[:sort_by], filter_by: params[:filter_by], query: params[:query]),
                class: "flex items-center gap-3 px-4 py-3 text-sm text-gray-800 rounded-lg hover:bg-gray-100 #{'bg-gray-100 font-semibold' if params[:category_id].blank?}" do %>
              <i data-lucide="gallery-horizontal-end" class="text-muted w-5 h-5"></i>
              <span>All Categories</span>
            <% end %>

            <div class="border-t border-gray-200 pt-2">
              <% @categories.each do |category| %>
                <%= link_to movies_path(year: current_year, category_id: category.id, sort_by: params[:sort_by], filter_by: params[:filter_by], query: params[:query]),
                    class: "flex items-center gap-3 px-4 py-3 text-sm text-gray-800 rounded-lg hover:bg-gray-100 #{'bg-gray-100 font-semibold' if params[:category_id].to_s == category.id.to_s}" do %>
                  <span><%= category.name %></span>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>

<%# Footer %>
<footer class="footer" style="background-color: var(--oscar-gold-dark); margin-top: 120px;">
  <div class="footer-content">
    <%# Left column - All links %>
    <div class="footer-links">
      <%= link_to "About", "javascript:void(0)", class: "footer-link", target: "_blank", rel: "noopener noreferrer" %>
      <%= link_to "Report bug", report_bug_path, class: "footer-link" %>
      <%= link_to "Request a feature", request_feature_path, class: "footer-link" %>
      <%= link_to "GitHub", "https://github.com/natelia/OscarsMates", class: "footer-link", target: "_blank", rel: "noopener noreferrer" %>
    </div>

    <%# Center - Logo %>
    <div class="footer-logo">
      <%= image_tag 'logo_hands_h-01.svg', alt: 'Oscars Mates Logo', class: 'h-64 w-auto' %>
    </div>

    <%# Right column - Bubble image %>
    <div class="footer-bubble">
      <%= image_tag 'love.svg', alt: 'Love what we do', class: 'footer-bubble-image' %>
    </div>
  </div>
</footer>

<style>
/* Toolbar responsive - handled in custom.css */
@media (max-width: 1023px) {
  .search-form {
    width: 100%;
  }
}
</style>
