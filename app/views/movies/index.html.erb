<a id="top"></a>

<main class="movies-page">
  <div class="container py-4">
    <%# Hero Section %>
    <header class="text-center mb-4">
      <h1 class="page-title mb-2"><%= current_year %> Oscar Nominees</h1>
      <p class="text-muted">
        <i class="bi bi-film me-1"></i>
        <%= pluralize(@movies.count, 'film') %> from <%= current_year - 1 %>
        <% if current_user && @progress %>
          <span class="mx-2">|</span>
          <i class="bi bi-check-circle me-1 text-gold"></i>
          <%= number_to_percentage(@progress, precision: 0) %> watched
        <% end %>
      </p>
    </header>

    <%# Toolbar %>
    <div class="toolbar">
      <%# Search %>
      <form class="d-flex flex-grow-1" role="search" action="<%= movies_path(year: current_year) %>" method="get" style="max-width: 400px;">
        <input class="form-control search-input me-2"
               type="search"
               name="query"
               placeholder="Search movies..."
               aria-label="Search"
               value="<%= params[:query] %>">
        <button class="btn btn-oscar" type="submit">
          <i class="bi bi-search"></i>
        </button>
      </form>

      <% if current_user.present? %>
        <div class="d-flex gap-2 flex-wrap">
          <%# Filter Toggle %>
          <% if params[:filter_by] == 'unwatched' %>
            <%= link_to movies_path(year: current_year), class: "btn btn-outline-oscar" do %>
              <i class="bi bi-grid-3x3-gap"></i> All Movies
            <% end %>
          <% else %>
            <%= link_to movies_path(year: current_year, filter_by: 'unwatched'), class: "btn btn-outline-oscar" do %>
              <i class="bi bi-eye-slash"></i> Unwatched
            <% end %>
          <% end %>

          <%# Sort Dropdown %>
          <%= form_tag movies_path(year: current_year), method: :get, class: "d-inline" do %>
            <%= select_tag :sort_by,
                options_for_select([
                  ['Default', ''],
                  ['By Length', 'duration'],
                  ['Popular with Mates', 'watched_by_mates'],
                  ['Most Nominated', 'most_nominated']
                ], params[:sort_by]),
                onchange: 'this.form.submit()',
                class: 'form-select form-select-sm',
                style: 'width: auto;' %>
            <%= hidden_field_tag :query, params[:query] if params[:query].present? %>
            <%= hidden_field_tag :filter_by, params[:filter_by] if params[:filter_by].present? %>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# Celebration %>
    <div data-controller="confetti" data-confetti-enabled-value="<%= @all_movies_watched %>">
      <% if @all_movies_watched %>
        <div class="alert bg-gold-light text-center rounded-oscar mb-4 animate-fade-in-up">
          <i class="bi bi-trophy-fill text-gold me-2" style="font-size: 1.5rem;"></i>
          <strong>Congratulations!</strong> You've watched all <%= current_year %> Oscar nominees!
        </div>
      <% end %>
    </div>

    <%# Movie Grid %>
    <% if @movies.any? %>
      <div class="movies-grid">
        <% @movies.each_with_index do |movie, index| %>
          <div class="animate-fade-in-up animate-delay-<%= [index + 1, 12].min %>">
            <%= render 'movie_card', movie: movie, review: @user_reviews[movie.id] %>
          </div>
        <% end %>
      </div>
    <% else %>
      <%# Empty State %>
      <div class="empty-state">
        <div class="empty-icon">
          <i class="bi bi-film"></i>
        </div>
        <h3>No movies found</h3>
        <p>
          <% if params[:query].present? %>
            No results for "<%= params[:query] %>". Try a different search.
          <% elsif params[:filter_by] == 'unwatched' %>
            You've watched everything! Amazing!
          <% else %>
            No movies available for this year yet.
          <% end %>
        </p>
        <% if params[:query].present? || params[:filter_by].present? %>
          <%= link_to "Clear Filters", movies_path(year: current_year), class: "btn btn-oscar" %>
        <% end %>
      </div>
    <% end %>

    <%# Admin Button %>
    <% if current_user_admin? %>
      <div class="text-center mt-4">
        <%= link_to new_movie_path(year: current_year), class: "btn btn-outline-oscar" do %>
          <i class="bi bi-plus-circle me-1"></i> Add New Movie
        <% end %>
      </div>
    <% end %>
  </div>

  <%# Back to Top %>
  <a href="#top" class="btn btn-oscar back-to-top" title="Back to top">
    <i class="bi bi-chevron-up"></i>
  </a>
</main>

<style>
.back-to-top {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--card-shadow-lg);
  z-index: 100;
  opacity: 0.9;
  transition: var(--transition-smooth);
}

.back-to-top:hover {
  opacity: 1;
  transform: translateY(-4px);
}

/* Toolbar responsive */
@media (max-width: 768px) {
  .toolbar {
    flex-direction: column;
    gap: 1rem;
  }

  .toolbar form {
    width: 100% !important;
    max-width: none !important;
  }
}
</style>
