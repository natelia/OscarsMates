<main class="user-profile py-5">
  <div class="container">
    <div class="text-center mb-4">
      <h1 class="display-4"><%= @user.name %></h1>
      <p>
        <strong>Follows:</strong> <%= @user.following.count %>
        <strong class="ms-3">Followers:</strong> <%= @user.followers.count %>
      </p>
      <p><%= mail_to(@user.email) %></p>
      <p class="text-muted">
        Member Since <%= @user.created_at.strftime("%B %Y") %>
      </p>

      <div class="progress my-3" role="progressbar" aria-label="Movies watched progress" aria-valuenow="<%= @progress %>" aria-valuemin="0" aria-valuemax="100">
        <div class="progress-bar bg-success" style="width: <%= @progress %>%;">
          <%= number_to_percentage(@progress, precision: 0) %> Watched
        </div>
      </div>

      <% unless current_user?(@user) %>
        <% if current_user.following.include?(@user) %>
          <%= button_to unfollow_user_path(@user),
              method: :delete,
              class: "btn btn-danger",
              aria: { label: "Unfollow #{@user.name}" },
              data: { disable_with: "Unfollowing..." } do %>
            <i class="bi bi-person-dash me-1" aria-hidden="true"></i> Unfollow
          <% end %>
        <% else %>
          <%= button_to follow_user_path(@user),
              method: :post,
              class: "btn btn-primary",
              aria: { label: "Follow #{@user.name}" },
              data: { disable_with: "Following..." } do %>
            <i class="bi bi-person-plus me-1" aria-hidden="true"></i> Follow
          <% end %>
        <% end %>
      <% end %>
    </div>

    <% if @reviews.present? %>
      <%= render layout: 'shared/accordion_section', locals: { id: 'reviews', title: 'Recently Watched' } do %>
        <% @reviews.each do |review| %>
          <%= render 'shared/media_item',
              movie: review.movie,
              stars: review.stars,
              subtitle: "Watched on: #{review.watched_on || review.created_at.strftime('%B %d, %Y')}",
              comment: review.comment %>
        <% end %>
      <% end %>
    <% end %>

    <% if @favorite_movies.present? %>
      <%= render layout: 'shared/accordion_section', locals: { id: 'favorites', title: 'Favorite Movies' } do %>
        <% @favorite_movies.each do |movie| %>
          <%= render 'shared/media_item', movie: movie %>
        <% end %>
      <% end %>
    <% end %>

    <% if @top_rated_movies.present? %>
      <%= render layout: 'shared/accordion_section', locals: { id: 'topRated', title: 'Top-Rated Movies' } do %>
        <% @top_rated_movies.each do |movie| %>
          <% review = movie.reviews.find_by(user: @user) %>
          <%= render 'shared/media_item',
              movie: movie,
              stars: review&.stars %>
        <% end %>
      <% end %>
    <% end %>

    <% if current_user?(@user) %>
      <div class="actions mb-4 text-center">
        <%= link_to edit_user_path(@user), class: "btn btn-warning me-2" do %>
          <i class="bi bi-pencil me-1" aria-hidden="true"></i> Edit Account
        <% end %>
        <%= link_to user_path(@user), class: "btn btn-danger",
                    data: { turbo_method: :delete, turbo_confirm: "Permanently delete your account?!" } do %>
          <i class="bi bi-trash me-1" aria-hidden="true"></i> Delete Account
        <% end %>
      </div>
    <% end %>

    <div class="text-center">
      <%= link_to root_path, class: "btn btn-primary" do %>
        <i class="bi bi-house me-1" aria-hidden="true"></i> Home Page
      <% end %>
    </div>
  </div>
</main>
