<section class="user py-10">
  <div class="container mx-auto px-4">
    <div class="mx-auto max-w-4xl">
      <div class="text-center mb-8 space-y-2">
        <h1 class="text-3xl font-semibold text-slate-900"><%= @user.name %></h1>
        <div class="flex flex-wrap justify-center gap-4 text-sm text-slate-600">
          <span><strong class="text-slate-900">Follows:</strong> <%= @user.following.count %></span>
          <span><strong class="text-slate-900">Followers:</strong> <%= @user.followers.count %></span>
        </div>
        <h4 class="text-sm font-semibold text-slate-700"><%= mail_to(@user.email, @user.email, class: "hover:text-slate-900") %></h4>
        <p class="text-sm text-slate-500">
          Member Since <%= @user.created_at.strftime("%B %Y") %>
        </p>

        <div class="mt-4">
          <div class="flex items-center justify-between text-xs font-semibold text-slate-500">
            <span>Progress</span>
            <span><%= number_to_percentage(@progress, precision: 0) %></span>
          </div>
          <div class="mt-2 h-3 w-full overflow-hidden rounded-full bg-slate-200">
            <div class="flex h-full items-center justify-center bg-emerald-500 text-[10px] font-semibold text-white" style="width: <%= @progress %>%;">
              <%= number_to_percentage(@progress, precision: 0) %> Watched
            </div>
          </div>
        </div>

        <% unless current_user?(@user) %>
          <% if current_user.following.include?(@user) %>
            <%= button_to 'Unfollow', unfollow_user_path(@user), method: :delete, class: "mt-4 inline-flex items-center rounded-md border border-red-200 px-4 py-2 text-sm font-semibold text-red-600 hover:bg-red-50", data: { disable_with: "Unfollowing..." } %>
          <% else %>
            <%= button_to 'Follow', follow_user_path(@user), method: :post, class: "mt-4 inline-flex items-center rounded-md bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800", data: { disable_with: "Following..." } %>
          <% end %>
        <% end %>
      </div>

      <div class="hs-accordion-group space-y-4">
        <% if @reviews.present? %>
          <div class="hs-accordion" id="reviews-accordion">
            <button class="hs-accordion-toggle flex w-full items-center justify-between rounded-lg border border-slate-200 bg-white px-4 py-3 text-left text-sm font-semibold text-slate-800" aria-controls="reviews-panel">
              <span>Recently Watched</span>
              <i class="bi bi-chevron-down text-xs text-slate-500 hs-accordion-active:rotate-180"></i>
            </button>
            <div id="reviews-panel" class="hs-accordion-content hidden">
              <div class="mt-4 space-y-4 rounded-lg border border-slate-200 bg-white p-4">
                <% @reviews.each do |review| %>
                  <div class="flex gap-4 rounded-lg border border-slate-200 bg-slate-50 p-4">
                    <% if review.movie.picture_url.present? %>
                      <img src="<%= review.movie.picture_url %>" alt="<%= review.movie.title %> Poster" class="h-[90px] w-[60px] rounded object-cover">
                    <% end %>

                    <div>
                      <div class="text-sm font-semibold text-slate-900">
                        <%= link_to review.movie.title, movie_path(year: current_year, id: review.movie.id), class: "hover:text-slate-700" %> -
                        <span class="text-amber-500"><%= render_stars(review.stars) %></span>
                      </div>
                      <div class="text-xs text-slate-500">
                        Watched on: <%= review.watched_on || review.created_at.strftime('%B %d, %Y') %>
                      </div>
                      <p class="mt-2 text-sm text-slate-600">
                        <%= review.comment %>
                      </p>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>

        <% if @favorite_movies.present? %>
          <div class="hs-accordion" id="favorites-accordion">
            <button class="hs-accordion-toggle flex w-full items-center justify-between rounded-lg border border-slate-200 bg-white px-4 py-3 text-left text-sm font-semibold text-slate-800" aria-controls="favorites-panel">
              <span>Favorite Movies</span>
              <i class="bi bi-chevron-down text-xs text-slate-500 hs-accordion-active:rotate-180"></i>
            </button>
            <div id="favorites-panel" class="hs-accordion-content hidden">
              <div class="mt-4 space-y-4 rounded-lg border border-slate-200 bg-white p-4">
                <% @favorite_movies.each do |movie| %>
                  <div class="flex gap-4 rounded-lg border border-slate-200 bg-slate-50 p-4">
                    <% if movie.picture_url.present? %>
                      <img src="<%= movie.picture_url %>" alt="<%= movie.title %> Poster" class="h-[90px] w-[60px] rounded object-cover">
                    <% end %>

                    <div class="text-sm font-semibold text-slate-900">
                      <%= link_to movie.title, movie_path(year: current_year, id: movie.id), class: "hover:text-slate-700" %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>

        <% if @top_rated_movies.present? %>
          <div class="hs-accordion" id="top-rated-accordion">
            <button class="hs-accordion-toggle flex w-full items-center justify-between rounded-lg border border-slate-200 bg-white px-4 py-3 text-left text-sm font-semibold text-slate-800" aria-controls="top-rated-panel">
              <span>Top-Rated Movies</span>
              <i class="bi bi-chevron-down text-xs text-slate-500 hs-accordion-active:rotate-180"></i>
            </button>
            <div id="top-rated-panel" class="hs-accordion-content hidden">
              <div class="mt-4 space-y-4 rounded-lg border border-slate-200 bg-white p-4">
                <% @top_rated_movies.each do |movie| %>
                  <div class="flex gap-4 rounded-lg border border-slate-200 bg-slate-50 p-4">
                    <% if movie.picture_url.present? %>
                      <img src="<%= movie.picture_url %>" alt="<%= movie.title %> Poster" class="h-[90px] w-[60px] rounded object-cover">
                    <% end %>

                    <div class="text-sm font-semibold text-slate-900">
                      <%= link_to movie.title, movie_path(year: current_year, id: movie.id), class: "hover:text-slate-700" %> -
                      <span class="text-amber-500"><%= render_stars(movie.reviews.find_by(user: @user).stars) %></span>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <% if current_user?(@user) %>
        <div class="actions mt-8 flex flex-wrap justify-center gap-3">
          <%= link_to "Edit Account", edit_user_path(@user), class: "inline-flex items-center rounded-md border border-amber-200 px-4 py-2 text-sm font-semibold text-amber-700 hover:bg-amber-50" %>
          <%= link_to "Delete Account", user_path(@user), class: "inline-flex items-center rounded-md border border-red-200 px-4 py-2 text-sm font-semibold text-red-600 hover:bg-red-50",
                        data: { turbo_method: :delete, turbo_confirm: "Permanently delete your account?!" } %>
        </div>
      <% end %>

      <div class="mt-8 text-center">
        <%= link_to "Home Page", root_path, class: "inline-flex items-center rounded-md bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800" %>
      </div>
    </div>
  </div>
</section>
