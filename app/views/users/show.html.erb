<main class="profile-page">
  <div class="container mx-auto px-4 py-8">
    <%# Header %>
    <div class="profile-header">
      <div class="profile-header-left">
        <% if current_user?(@user) %>
          <%= form_with model: @user, url: user_path(@user), method: :patch, local: true, data: { controller: "avatar-upload" }, class: "profile-avatar-form" do |form| %>
            <div class="profile-avatar-wrapper" data-avatar-upload-target="preview">
              <% if @user.avatar.attached? %>
                <%= image_tag url_for(@user.avatar), class: "profile-avatar-img" %>
              <% else %>
                <div class="profile-avatar-placeholder" style="background-color: <%= avatar_color(@user.name) %>;">
                  <%= avatar_initials(@user.name) %>
                </div>
              <% end %>
              <label for="profile-avatar-upload" class="profile-avatar-overlay">
                <i data-lucide="pencil"></i>
              </label>
              <%= form.file_field :avatar,
                    id: "profile-avatar-upload",
                    accept: "image/png,image/jpeg,image/gif,image/webp",
                    class: "sr-only",
                    data: { avatar_upload_target: "input", action: "change->avatar-upload#preview change->avatar-upload#submit" } %>
            </div>
          <% end %>
        <% else %>
          <div class="profile-avatar-wrapper">
            <% if @user.avatar.attached? %>
              <%= image_tag url_for(@user.avatar), class: "profile-avatar-img" %>
            <% else %>
              <div class="profile-avatar-placeholder" style="background-color: <%= avatar_color(@user.name) %>;">
                <%= avatar_initials(@user.name) %>
              </div>
            <% end %>
          </div>
        <% end %>
        <div class="profile-header-info">
          <h1 class="page-title text-xl sm:text-2xl md:text-3xl mb-0"><%= @user.name %></h1>
        </div>
      </div>

      <%# Actions %>
      <div class="profile-header-actions">
        <% unless current_user?(@user) %>
          <% if current_user&.following&.include?(@user) %>
            <%= button_to 'Unfollow', unfollow_user_path(@user), method: :delete, class: "btn-outline-oscar btn-sm", data: { disable_with: "Unfollowing..." } %>
          <% elsif current_user %>
            <%= button_to 'Follow', follow_user_path(@user), method: :post, class: "btn-oscar btn-sm", data: { disable_with: "Following..." } %>
          <% end %>
        <% end %>
        <% if current_user?(@user) %>
          <%= link_to edit_user_path(@user), class: "btn-outline-oscar btn-sm" do %>
            <i data-lucide="settings"></i> Account settings
          <% end %>
        <% end %>
      </div>
    </div>

    <%# Stats Row %>
    <div class="flex flex-wrap items-center gap-3 mt-4">
      <div class="stat-badge">
        <i data-lucide="user-plus"></i>
        <span>Following: <strong><%= @user.following.count %></strong></span>
      </div>
      <div class="stat-badge">
        <i data-lucide="users"></i>
        <span>Followers: <strong><%= @user.followers.count %></strong></span>
      </div>
      <div class="stat-badge">
        <i data-lucide="calendar"></i>
        <span>Member since: <strong><%= @user.created_at.strftime("%B %Y") %></strong></span>
      </div>
    </div>

    <%# Content Sections %>
    <div class="profile-sections mt-8">
      <% if @reviews.present? %>
        <div class="profile-section">
          <div class="profile-section-header">
            <i data-lucide="eye" class="text-muted"></i>
            <h2 class="profile-section-title">Recently Watched</h2>
            <span class="profile-section-count"><%= @reviews.count %></span>
          </div>
          <div class="profile-section-content">
            <% @reviews.each do |review| %>
              <div class="profile-movie-item">
                <% if review.movie.picture_url.present? %>
                  <img src="<%= review.movie.picture_url %>" alt="<%= review.movie.title %>" class="profile-movie-poster">
                <% end %>
                <div class="profile-movie-info">
                  <div class="profile-movie-title">
                    <%= link_to review.movie.title, movie_path(year: current_year, id: review.movie.id) %>
                    <span class="text-gold"><%= render_stars(review.stars) %></span>
                  </div>
                  <div class="text-sm text-muted">
                    Watched on:
                    <span title="<%= review.watched_on.strftime('%I:%M %p') %>">
                      <%= review.watched_on.strftime('%B %d, %Y') %>
                    </span>
                  </div>
                  <% if review.comment.present? %>
                    <p class="text-sm text-secondary mt-1"><%= review.comment %></p>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if @favorite_movies.present? %>
        <div class="profile-section">
          <div class="profile-section-header">
            <i data-lucide="heart" class="text-muted"></i>
            <h2 class="profile-section-title">Favorite Movies</h2>
            <span class="profile-section-count"><%= @favorite_movies.count %></span>
          </div>
          <div class="profile-section-content">
            <% @favorite_movies.each do |movie| %>
              <div class="profile-movie-item">
                <% if movie.picture_url.present? %>
                  <img src="<%= movie.picture_url %>" alt="<%= movie.title %>" class="profile-movie-poster">
                <% end %>
                <div class="profile-movie-info">
                  <div class="profile-movie-title">
                    <%= link_to movie.title, movie_path(year: current_year, id: movie.id) %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <%# Danger Zone %>
    <% if current_user?(@user) %>
      <div class="profile-danger-zone mt-8">
        <%= link_to user_path(@user), class: "btn-danger btn-sm",
              data: { turbo_method: :delete, turbo_confirm: "Permanently delete your account?!" } do %>
          <i data-lucide="trash-2"></i> Delete Account
        <% end %>
      </div>
    <% end %>
  </div>
</main>
