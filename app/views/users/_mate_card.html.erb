<%# Mate Card Partial %>
<%# Local variables: user, total_movies, year, current_user, rank (optional) %>
<% rank ||= nil %>
<% progress = user_progress_for_year(user, year, total_movies) %>
<% watched_count = user.watched_movies_count_for_year(year) %>
<% last_movie = last_watched_movie(user, year) %>

<div class="mate-card card-lift">
  <%# Avatar %>
  <div class="avatar-circle" style="background-color: <%= avatar_color(user.name) %>;">
    <%= avatar_initials(user.name) %>
  </div>

  <%# User Info %>
  <div class="flex-1">
    <div class="flex items-start justify-between gap-3 mb-2">
      <div>
        <%= link_to user_path(user), class: "no-underline hover:text-slate-700" do %>
          <h5 class="mb-0" style="color: var(--charcoal);">
            <%= user.name %>
            <% if rank %>
              <span class="ml-1"><%= rank_badge(rank) %></span>
            <% end %>
          </h5>
        <% end %>
        <small class="text-muted">
          <%= pluralize(watched_count, 'movie') %> watched
        </small>
      </div>

      <%# Follow/Unfollow Button %>
      <% if current_user && user != current_user %>
        <% if current_user.following.include?(user) %>
          <%= button_to unfollow_user_path(user),
              method: :delete,
              class: "inline-flex items-center justify-center rounded-md border border-red-200 px-2.5 py-1 text-xs font-semibold text-red-600 hover:bg-red-50",
              data: { disable_with: "..." } do %>
            <i data-lucide="user-minus" class="text-muted"></i>
          <% end %>
        <% else %>
          <%= button_to follow_user_path(user),
              method: :post,
              class: "btn-oscar btn-sm",
              data: { disable_with: "..." } do %>
            <i data-lucide="user-plus" class="text-muted"></i>
          <% end %>
        <% end %>
      <% end %>
    </div>

    <%# Progress Bar %>
    <div class="progress-bar-oscar progress-animated mb-2">
      <div class="progress-fill" style="--progress: <%= progress %>%; width: <%= progress %>%;"></div>
    </div>
    <div class="flex items-center justify-between">
      <small class="text-muted">
        <%= number_to_percentage(progress, precision: 0) %> complete
      </small>

      <%# Last Watched Movie (mini poster) %>
      <% if last_movie %>
        <%= link_to movie_path(last_movie, year: year), class: "flex items-center no-underline hover:text-slate-700", title: "Last watched: #{last_movie.title}" do %>
          <small class="text-muted mr-2">Last:</small>
          <% if last_movie.picture_url.present? %>
            <img src="<%= last_movie.picture_url %>"
                 alt="<%= last_movie.title %>"
                 class="rounded"
                 style="width: 32px; height: 48px; object-fit: cover;"
                 loading="lazy">
          <% else %>
            <div class="rounded bg-gold-light flex items-center justify-center"
                 style="width: 32px; height: 48px;">
              <i data-lucide="film" class="text-muted" style="font-size: 0.75rem;"></i>
            </div>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
