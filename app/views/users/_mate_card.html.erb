<%# Mate Card Partial %>
<%# Local variables: user, total_movies, year, current_user, rank (optional), watched_counts (optional) %>
<% rank ||= nil %>
<% watched_counts ||= nil %>
<% progress = user_progress_for_year(user, year, total_movies, watched_counts: watched_counts) %>
<% watched_count = watched_counts ? (watched_counts[user.id] || 0) : user.watched_movies_count_for_year(year) %>
<% last_movie = last_watched_movie(user, year) %>

<article class="mate-card card-lift" aria-label="<%= user.name %>'s profile card">
  <%# Avatar %>
  <%= render 'shared/avatar', name: user.name, size: 'md' %>

  <%# User Info %>
  <div class="flex-grow-1">
    <div class="d-flex justify-content-between align-items-start mb-2">
      <div>
        <%= link_to user_path(user), class: "text-decoration-none" do %>
          <h5 class="mb-0">
            <%= user.name %>
            <% if rank %>
              <span class="ms-1"><%= rank_badge(rank) %></span>
            <% end %>
          </h5>
        <% end %>
        <small class="text-muted">
          <%= pluralize(watched_count, 'movie') %> watched
        </small>
      </div>

      <%# Follow/Unfollow Button %>
      <% if current_user && user != current_user %>
        <% if current_user.following.include?(user) %>
          <%= button_to unfollow_user_path(user),
              method: :delete,
              class: "btn btn-sm btn-outline-danger",
              aria: { label: "Unfollow #{user.name}" },
              data: { disable_with: "..." } do %>
            <i class="bi bi-person-dash" aria-hidden="true"></i>
          <% end %>
        <% else %>
          <%= button_to follow_user_path(user),
              method: :post,
              class: "btn btn-sm btn-oscar",
              aria: { label: "Follow #{user.name}" },
              data: { disable_with: "..." } do %>
            <i class="bi bi-person-plus" aria-hidden="true"></i>
          <% end %>
        <% end %>
      <% end %>
    </div>

    <%# Progress Bar %>
    <div class="progress-bar-oscar progress-animated mb-2" role="progressbar" aria-valuenow="<%= progress %>" aria-valuemin="0" aria-valuemax="100" aria-label="<%= user.name %>'s watching progress">
      <div class="progress-fill" style="--progress: <%= progress %>%; width: <%= progress %>%;"></div>
    </div>
    <div class="d-flex justify-content-between align-items-center">
      <small class="text-muted">
        <%= number_to_percentage(progress, precision: 0) %> complete
      </small>

      <%# Last Watched Movie (mini poster) %>
      <% if last_movie %>
        <%= link_to movie_path(last_movie, year: year), class: "d-flex align-items-center text-decoration-none", aria: { label: "Last watched: #{last_movie.title}" } do %>
          <small class="text-muted me-2">Last:</small>
          <% if last_movie.picture_url.present? %>
            <img src="<%= last_movie.picture_url %>"
                 alt="Movie poster for <%= last_movie.title %>"
                 class="rounded poster-xs"
                 loading="lazy">
          <% else %>
            <div class="rounded bg-gold-light d-flex align-items-center justify-content-center poster-xs">
              <i class="bi bi-film text-gold icon-xs" aria-hidden="true"></i>
            </div>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>
</article>
