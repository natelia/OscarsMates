<main class="ranking-page" data-controller="ranking-filter">
  <div class="container mx-auto px-4 py-8">
    <%# Header %>
    <div class="ranking-header">
      <h1 class="page-title mb-0">Ranking</h1>

      <%# Summary Statistics %>
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mt-3">
        <div class="flex flex-wrap items-center gap-3">
          <div class="stat-badge">
            <i data-lucide="film"></i>
            <span>All films: <strong><%= @totals[:films] %></strong></span>
          </div>
          <div class="stat-badge">
            <i data-lucide="clock"></i>
            <span>Total time: <strong><%= (@totals[:minutes] / 60).to_i %>h <%= @totals[:minutes] % 60 %>min</strong></span>
          </div>
          <div class="stat-badge">
            <i data-lucide="trophy"></i>
            <span>Total nominations: <strong><%= @totals[:nominations] %></strong></span>
          </div>
        </div>

        <%# Search Input %>
        <div class="flex flex-wrap items-center gap-3">
          <form class="search-form"
                role="search"
                data-action="submit->ranking-filter#submitSearch">
            <i data-lucide="search" class="search-icon"></i>
            <input class="search-input"
                   type="search"
                   name="query"
                   placeholder="Search mates..."
                   aria-label="Search"
                   value="<%= @query %>"
                   data-ranking-filter-target="searchInput"
                   data-action="input->ranking-filter#search">
            <% if @query.present? %>
              <button type="button"
                      class="search-clear"
                      data-action="click->ranking-filter#clearSearch">
                <i data-lucide="x"></i>
              </button>
            <% end %>
          </form>
        </div>
      </div>
    </div>

    <%# Filter Bar %>
    <div class="ranking-filters">
      <%# Filter Group 1: Metric Selector %>
      <div class="ranking-filter-group">
        <span class="ranking-filter-label">Sort by:</span>
        <div class="filter-pill">
          <% %i[films minutes nominations].each do |metric| %>
            <a href="#"
               class="filter-option <%= 'active' if @metric == metric %>"
               data-metric="<%= metric %>"
               data-action="click->ranking-filter#setMetric">
              <i data-lucide="<%= metric == :films ? 'film' : (metric == :minutes ? 'clock' : 'trophy') %>"></i>
              <%= metric.to_s.capitalize %>
            </a>
          <% end %>
        </div>
      </div>

      <%# Filter Group 2: Mode Selector %>
      <div class="ranking-filter-group">
        <span class="ranking-filter-label">Show:</span>
        <div class="filter-pill">
          <% %i[goals totals].each do |mode| %>
            <a href="#"
               class="filter-option <%= 'active' if @mode == mode %>"
               data-mode="<%= mode %>"
               data-action="click->ranking-filter#setMode">
              <i data-lucide="<%= mode == :goals ? 'percent' : 'hash' %>"></i>
              <%= mode.to_s.capitalize %>
            </a>
          <% end %>
        </div>
      </div>

      <%# Filter Group 3: Scope Selector %>
      <div class="ranking-filter-group">
        <span class="ranking-filter-label">Users:</span>
        <div class="filter-pill">
          <% %i[mates all].each do |scope| %>
            <a href="#"
               class="filter-option <%= 'active' if @scope == scope %>"
               data-scope="<%= scope %>"
               data-action="click->ranking-filter#setScope">
              <i data-lucide="<%= scope == :mates ? 'heart' : 'users' %>"></i>
              <%= scope == :mates ? 'My mates' : 'All users' %>
            </a>
          <% end %>
        </div>
      </div>
    </div>

    <%# Ranking List %>
    <% if @ranked_users.any? %>
      <div class="ranking-list" data-ranking-filter-target="rankingList">
        <% @ranked_users.each do |ranked_user| %>
          <%= render 'ranking_item',
              ranked_user: ranked_user,
              current_user: current_user,
              main_metric: @metric %>
        <% end %>
      </div>
    <% else %>
      <%# Empty State %>
      <div class="empty-state">
        <div class="empty-icon">
          <i data-lucide="users" class="text-muted"></i>
        </div>
        <h3>No mates found</h3>
        <p>
          <% if @query.present? %>
            No results for "<%= @query %>".
          <% elsif @scope == :mates && current_user %>
            You're not following anyone yet. Start following mates to see them here!
          <% else %>
            Be the first to join the Oscar watching party!
          <% end %>
        </p>
        <% if @query.present? %>
          <%= link_to users_path, class: "btn-oscar" do %>
            <i data-lucide="x" class="mr-1 text-muted"></i> Clear search
          <% end %>
        <% elsif @scope == :mates %>
          <%= link_to users_path(scope: 'all'), class: "btn-oscar" do %>
            <i data-lucide="users" class="mr-1 text-muted"></i> Browse All Mates
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>

  <%# Back to Top %>
  <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="back-to-top" title="Back to top">
    <i data-lucide="arrow-up" style="color: var(--text-tertiary);"></i>
  </button>
</main>

<style>
.back-to-top {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--card-shadow-lg);
  z-index: 1000;
  opacity: 0.9;
  transition: var(--transition-smooth);
  background: var(--bg-secondary);
}

.back-to-top:hover {
  opacity: 1;
  transform: translateY(-4px);
}
</style>
