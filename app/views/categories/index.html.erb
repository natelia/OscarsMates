<a id="top"></a>

<main class="categories-page">
  <div class="container mx-auto px-4 py-8">
    <div class="categories-header">
      <h1 class="page-title mb-0">Nominations</h1>

      <!-- Summary Statistics and Actions Row -->
      <div class="categories-stats-actions flex flex-col gap-3 md:flex-row md:items-center md:justify-between mt-3">
        <div class="categories-stats-row flex flex-wrap items-center gap-3">
          <div class="stat-badge">
            <i data-lucide="film"></i>
            <span><%= current_year %> Awards nominees: <strong><%= @total_nominees %></strong></span>
          </div>
          <div class="stat-badge">
            <i data-lucide="calendar"></i>
            <span>Days until ceremony: <strong><%= @days_until_ceremony %></strong></span>
          </div>
          <div class="stat-badge">
            <i data-lucide="trophy"></i>
            <span>Category winners left to pick: <strong id="categories-left-count"><%= @categories_count %></strong></span>
          </div>
        </div>

        <div class="categories-search-row flex flex-wrap items-center gap-3">
          <form class="search-form" role="search" action="<%= categories_path(year: current_year) %>" method="get">
            <i data-lucide="search" class="search-icon"></i>
            <input class="search-input"
                   type="search"
                   name="query"
                   placeholder="Search..."
                   aria-label="Search"
                   value="<%= params[:query] %>">
          </form>

          <% if current_user_admin? %>
            <%= link_to new_category_path(year: current_year), class: "btn-admin-add" do %>
              <i data-lucide="plus"></i>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>

    <% if @categories.any? %>
      <div class="categories-list">
        <% @categories.each do |category| %>
          <% category_movies = @category_movies[category.id] || [] %>
          <% if category_movies.any? %>
            <% user_pick = @user_picks[category.id] %>
            <% picking_allowed = Date.today <= Date.new(current_year, 3, 15) %>
            <div class="category-row"
                 data-controller="category-pick"
                 data-category-pick-category-id-value="<%= category.id %>"
                 data-category-pick-year-value="<%= current_year %>"
                 data-category-pick-picking-allowed-value="<%= picking_allowed && current_user.present? %>">
              <!-- Category name column (4/12 columns) -->
              <div class="category-name-column">
                <div class="category-title-row">
                  <div class="category-icon-wrapper">
                    <i data-lucide="trophy" class="category-icon"></i>
                  </div>
                  <div class="category-title-wrapper">
                    <h2 class="category-title"><%= category.name %></h2>
                  </div>
                </div>
                <p class="text-base text-muted m-0 category-count-text"><%= pluralize(category_movies.count, 'nomination') %></p>
                <div class="category-pick-info">
                  <% if current_user %>
                    <p class="text-base text-muted m-0 category-count-text">
                      <i data-lucide="star" class="pick-info-star"></i>
                      Your nomination:
                    </p>
                    <p class="text-base m-0 category-count-text">
                      <% if user_pick %>
                        <span data-category-pick-target="nominationText" class="text-secondary font-bold"><%= user_pick.movie.title %></span>
                      <% elsif picking_allowed %>
                        <span data-category-pick-target="nominationText" class="text-muted italic">Pick a movie</span>
                      <% else %>
                        <span data-category-pick-target="nominationText" class="text-muted italic">You missed the deadline for voting</span>
                      <% end %>
                    </p>
                  <% end %>
                </div>
              </div>

              <!-- Movies grid column (8/12 columns) -->
              <div class="category-movies-column">
                <% category_movies.each do |movie| %>
                  <div class="category-movie-card <%= 'selected-pick' if user_pick&.movie_id == movie.id %>"
                       data-category-pick-target="movieCard"
                       data-movie-id="<%= movie.id %>"
                       data-action="click->category-pick#selectMovie"
                       style="cursor: <%= picking_allowed && current_user ? 'pointer' : 'default' %>">
                    <%= render 'movies/movie_card', movie: movie, review: @user_reviews[movie.id], pick_count: @pick_counts[[category.id, movie.id]] || 0 %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="empty-state">
        <div class="empty-icon">
          <i data-lucide="award" class="text-muted"></i>
        </div>
        <h3>No nominations found</h3>
        <p>
          <% if params[:query].present? %>
            No results for "<%= params[:query] %>".
          <% else %>
            No nominations available yet.
          <% end %>
        </p>
        <% if params[:query].present? %>
          <%= link_to "Clear", categories_path(year: current_year), class: "btn-oscar btn-sm" %>
        <% end %>
      </div>
    <% end %>
  </div>

  <%# Back to Top %>
  <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="back-to-top" title="Back to top">
    <i data-lucide="arrow-up" style="color: var(--text-tertiary);"></i>
  </button>
</main>
